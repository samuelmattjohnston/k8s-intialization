---
# -----------------------------------------------------------
# 0. PRE-REQUISITES
# -----------------------------------------------------------
- name: "Kernel: Install GPG and Curl"
  apt:
    name: [gpg, curl, ca-certificates]
    state: present
    update_cache: yes

# -----------------------------------------------------------
# 1. REPO SETUP
# -----------------------------------------------------------
- name: "Kernel: Ensure Keyrings Directory"
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: "Kernel: Download and Verify Zabbly Key"
  block:
    - name: "Fetch Zabbly Key to temporary location"
      get_url:
        url: https://pkgs.zabbly.com/key.asc
        dest: /tmp/zabbly.asc
        mode: '0644'

    - name: "Verify Key Fingerprint"
      shell: "gpg --with-colons --show-keys /tmp/zabbly.asc | grep -q '4EFC590696CB15B87C73A3AD82CC8797C838DCFD'"
      changed_when: false

    - name: "Move Verified Key to Keyring"
      copy:
        src: /tmp/zabbly.asc
        dest: /etc/apt/keyrings/zabbly.asc
        mode: '0644'
        remote_src: yes
  rescue:
    - name: "Fail if Fingerprint Mismatch"
      fail:
        msg: "The Zabbly GPG Key fingerprint did not match the expected value. Aborting."

- name: "Kernel: Add Zabbly Repository"
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/zabbly.asc] https://pkgs.zabbly.com/kernel/stable {{ debian_release }} main"
    filename: zabbly-kernel-stable
    state: present
  register: repo_added

- name: "Kernel: Update Apt Cache"
  apt:
    update_cache: yes
  when: repo_added.changed

# -----------------------------------------------------------
# 2. KERNEL INSTALLATION
# -----------------------------------------------------------
- name: "Kernel: Install Latest Zabbly Kernel"
  apt:
    name:
      - linux-zabbly
    state: latest
  register: kernel_upgrade

# -----------------------------------------------------------
# 3. GRUB TUNING
# -----------------------------------------------------------
- name: "Kernel: Set GRUB Timeout to 10s"
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_TIMEOUT='
    line: 'GRUB_TIMEOUT=10'
  register: grub_timeout
  notify: Update bootloader

- name: "Kernel: Configure GRUB Arguments"
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: >-
      GRUB_CMDLINE_LINUX_DEFAULT="{{ (grub_base_args + (ai_tuning_args if inventory_hostname in groups['ai_nodes'] else [])) | join(' ') }}"
  register: grub_config
  notify: Update bootloader
# -----------------------------------------------------------
# 4. REBOOT LOGIC
# -----------------------------------------------------------
- name: "Reboot: Check if OS requests reboot"
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: "Reboot: Trigger Reboot"
  reboot:
    msg: "Rebooting node for Kernel/Config updates"
    reboot_timeout: 300
    post_reboot_delay: 30
  when: >
    (kernel_upgrade.changed | default(false)) or
    (grub_config.changed | default(false)) or
    reboot_required_file.stat.exists
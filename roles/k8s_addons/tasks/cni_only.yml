# ==============================================================================
# 0. SETUP & TOOLS (Idempotent Fix)
# ==============================================================================
- include_role:
    name: networking
    tasks_from: normalize

- name: "Tools: Check installed Cilium CLI version"
  shell: "cilium version --client 2>/dev/null | grep -oE 'v[0-9]+\\.[0-9]+\\.[0-9]+' | head -n1"
  register: cilium_installed_version
  failed_when: false
  changed_when: false

- name: "Tools: Download Cilium CLI"
  get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/{{ versions.cilium_cli }}/cilium-linux-amd64.tar.gz"
    dest: /tmp/cilium-cli.tar.gz
    mode: '0644'
  register: download_cilium
  until: download_cilium is success
  retries: 5
  delay: 10
  # Only download if the version doesn't match OR if the command failed (not installed)
  when: cilium_installed_version.stdout != versions.cilium_cli

- name: "Tools: Install Cilium CLI"
  unarchive:
    src: /tmp/cilium-cli.tar.gz
    dest: /usr/local/bin
    remote_src: yes
    mode: '0755'
  # Only install if we actually downloaded it
  when: download_cilium is changed
# ==============================================================================
# 1. CILIUM (CNI Layer)
# ==============================================================================
- name: "Cilium: Check Status"
  command: cilium status --wait=false
  register: cilium_check
  failed_when: false
  changed_when: false

# ----------------------------------------------------------------------
# STEP 1: GLOBAL INSTALL (Base Layer)
# ----------------------------------------------------------------------
- name: "Cilium: Install (Base Layer)"
  environment:
     KUBECONFIG: /etc/kubernetes/admin.conf
  shell: >-
    cilium install
    --version {{ versions.cilium }}
    --set k8sServiceHost={{ networks.private.prefix }}.{{ cluster_private_vip }}
    --set k8sServicePort=6443
    --set kubeProxyReplacement=true
    --set cni.exclusive=false
    --set socketLB.hostNamespaceOnly=true
    --set k8s.requireIPv4PodCIDR=false
    --set ipam.mode=cluster-pool
    --set ipam.operator.clusterPoolIPv4PodCIDRList="{{ pod_network }}"
    --set l2announcements.enabled=false
    --set routingMode=native
    --set autoDirectNodeRoutes=true
    --set ipv4NativeRoutingCIDR="{{ pod_network }}"
    --set bpf.masquerade={{ cilium_config.bpf_masquerade | lower }}
    --set bpf.hostLegacyRouting=false
    --set nodeConfig.enabled=true
    --set vlan.enabled=true
    --wait
  register: cilium_install_cmd
  failed_when:
    - cilium_install_cmd.rc != 0
    - "'cannot re-use a name that is still in use' not in cilium_install_cmd.stderr"
  when: cilium_check.rc != 0

# ----------------------------------------------------------------------
# STEP 1.5: WAIT FOR CRD (Crucial Fix)
# ----------------------------------------------------------------------
- name: "Cilium: Wait for CiliumNodeConfig CRD to be Registered"
  environment:
     KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: ciliumnodeconfigs.cilium.io
  register: crd_check
  until:
    - crd_check.resources | length > 0
    - crd_check.resources[0].status.conditions | selectattr('type', 'equalto', 'Established') | selectattr('status', 'equalto', 'True') | list | length > 0
  retries: 30
  delay: 2

# ----------------------------------------------------------------------
# STEP 2: PER-HOST CONFIG
# ----------------------------------------------------------------------
- name: "Cilium: Apply Device Config Per Node"
  environment:
     KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cilium.io/v2
      kind: CiliumNodeConfig
      metadata:
        name: "cilium-config-{{ item }}"
        namespace: kube-system
      spec:
        nodeSelector:
          matchLabels:
            kubernetes.io/hostname: "{{ item }}"
        defaults:
          # 1. Identity Anchor (Use the Private IP for identity in native mode)
          direct-routing-device: "{{ hostvars[item].net_private_dev }}"

          # 2. Explicit Device String
          devices: "{{ hostvars[item].net_private_dev }},{{ hostvars[item].net_public_dev }}"
  loop: "{{ groups['k8s_cluster'] }}"

# ==============================================================================
# C. STABILIZATION
# ==============================================================================
- name: "CNI Stabilization: Wait for CoreDNS Pods to be Ready"
  environment:
     KUBECONFIG: /etc/kubernetes/admin.conf
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: kube-system
    label_selectors:
      - k8s-app=kube-dns
  register: coredns_pods
  until: >
    coredns_pods.resources is defined and
    (coredns_pods.resources | json_query('[].status.containerStatuses[].ready') | select('equalto', true) | list | length) == 2
  retries: 30
  delay: 10
